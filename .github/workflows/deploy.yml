name: Deploy LocalHub

on:
  push:
    branches: [Production]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy LocalHub to thelocalhub.gr
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Run frontend tests (if any)
        run: |
          cd frontend
          npm run test --if-present || echo "No frontend tests found"

      - name: Run backend tests (if any)
        run: |
          cd backend
          npm run test --if-present || echo "No backend tests found"

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build success
        run: echo "Application built successfully!"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "Starting deployment to thelocalhub.gr..."

            cd /home/${{ secrets.VPS_USERNAME }}/projects/localhub || {
              echo "Project directory not found."
              exit 1
            }

            echo "Backing up database and uploads..."
            mkdir -p /tmp/localhub-backup
            cp -r backend/data /tmp/localhub-backup/data 2>/dev/null || echo "No data folder to backup"
            cp -r backend/uploads /tmp/localhub-backup/uploads 2>/dev/null || echo "No uploads folder to backup"

            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/Production

            echo "Restoring database and uploads..."
            cp -r /tmp/localhub-backup/data backend/ 2>/dev/null || echo "No data folder to restore"
            cp -r /tmp/localhub-backup/uploads backend/ 2>/dev/null || echo "No uploads folder to restore"
            rm -rf /tmp/localhub-backup

            echo "Running deployment script..."
            chmod +x deploy.sh
            ./deploy.sh

            echo "Checking deployment status..."
            docker compose -f docker-compose.proxy.yml ps

            echo "Deployment completed!"
            echo "LocalHub is live at https://thelocalhub.gr"

      - name: Deployment Success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "App is live at https://thelocalhub.gr"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "Deployment failed!"
          echo "Check logs above."
